<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="js/jquery-1.12.4.min.js"></script>
  <script type="text/javascript" src="js/sockjs-1.1.1.min.js"></script>
  <script type="text/javascript" src="js/stomp.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
  <style type="text/css">
    h1 {
      text-align: center;
    }
    .container {
      margin: 20px;
    }
    .row {
      display: flex;
    }
    .column {
      flex: 1;
      padding: 10px;
    }
    .card {
      padding: 20px;
      background-color: #f8f9fa;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-light">
    <h1 class="navbar-brand mb-0">Big Data Dashboard</h1>
  </nav>
  
  <div class="container">
    <h3>Total Transactions: <span id="total-transactions">0</span></h3>
    <div class="row">
      <div class="column">
        <div class="card">
          <h4>Category Breakdown</h4>
          <div id="category-breakdown"></div>
        </div>
      </div>
      <div class="column">
        <div class="card">
          <h4>Geographic Distribution</h4>
          <div id="geographic-distribution"></div>
        </div>
      </div>
      <div class="column">
        <div class="card">
          <h4>Status Analysis</h4>
          <div id="status-analysis"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const stompClient = Stomp.over(new SockJS('/stomp'));
    stompClient.connect({}, () => {
      console.log("Connected to WebSocket");

      // Subscribe to Total Transactions
      stompClient.subscribe('/topic/data', (message) => {
		const data = JSON.parse(message.body);
		console.log("Received data:", data);
		// Update Total Transactions
		const totalTransactions = data.totalTransactions; // Direct access to totalTransactions value
		document.getElementById('total-transactions').textContent = totalTransactions;

		// Update Category Breakdown
		const breakdown = data.categoryBreakdown;
		const categoryContainer = document.getElementById('category-breakdown');
		categoryContainer.innerHTML = breakdown.map(item =>
			`<p>${item.category}: ${item.count}</p>`
		).join('');

		// Update Geographic Distribution
		const distribution = data.geographicDistribution;
		const geoContainer = document.getElementById('geographic-distribution');
		const countryCodes = {
    "SWITZERLAND": "ch",
    "BRAZIL": "br",
    "TUNISIA": "tn",
    "UAE": "ae",
    "MOROCCO": "ma",
    "FRANCE": "fr",
    "USA": "us"
  };
  
  geoContainer.innerHTML = distribution.map(item => {
    const countryCode = countryCodes[item.location.toUpperCase()] || 'us'; // Default to 'us' if not found
    return `
      <p>
        <img src="https://flagcdn.com/16x12/${countryCode}.png" alt="${item.location} flag">
        ${item.location}: ${item.count}
      </p>
    `;
  }).join('');
		
		// Update Status Analysis
		const analysis = data.statusAnalysis;
		const total = analysis.reduce((acc, item) => acc + item.count, 0); // Calculate total from all statuses
		const statusContainer = document.getElementById('status-analysis');
		statusContainer.innerHTML = analysis.map(item =>
			`<p>${item.status}: ${(item.count / total * 100).toFixed(2)}%</p>`
		).join('');
		});

    });
  </script>
</body>
</html>
